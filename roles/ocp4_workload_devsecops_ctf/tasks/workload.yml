---

- name: Prepare Variables
  ansible.builtin.include_tasks: prepare_variables.yml

- name: Render bootstrap definition
  set_fact:
    bootstrap_def: "{{ lookup('template', 'bootstrap-application.yaml.j2') | from_yaml }}"

- name: Show bootstrap definition (before apply)
  debug:
    var: bootstrap_def

- name: Save rendered YAML on the controller
  copy:
    content: "{{ bootstrap_def | to_nice_yaml(indent=2) }}\n"
    dest: /tmp/bootstrap-rendered.yaml
    mode: '0644'
  delegate_to: localhost
  run_once: true    

- name: Create bootstrap argocd application
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'bootstrap-application.yaml.j2') | from_yaml }}"
  retries: 10
  delay: 60
  ignore_errors: true
  register: workshop_result
  until: workshop_result is not failed

- name: Print result from the previous task
  ansible.builtin.debug:
    var: workshop_result